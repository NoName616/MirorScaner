# MirrorScan (Python)

Инженерный сканер для анализа температурного поля зеркал с использованием камеры Optris PI 640 и контроллера STM32F415RGT6.

## Описание

Это переписанная на Python версия приложения MirrorScan, изначально написанного на C#. Проект предназначен для автоматизированного сканирования поверхности зеркала с помощью инфракрасной камеры Optris PI 640, управляемой по USB, и механической системы перемещения на основе шаговых двигателей, управляемых через контроллер STM32. Приложение предоставляет графический интерфейс пользователя (GUI) для настройки параметров сканирования, калибровки оборудования, запуска процесса сканирования и визуализации/сохранения результатов.

## Основные функции

- **Подключение к оборудованию:**
  - Подключение к контроллеру STM32 через виртуальный COM-порт.
  - Подключение к инфракрасной камере Optris PI 640 (через `ImagerIPC2x64.dll`).
- **Калибровка:**
  - Механическая калибровка осей X и Theta (перемещение в крайние положения по концевикам).
  - Калибровка камеры: связь пиксельных координат изображения с физическими координатами сканируемой поверхности (радиус в мм, угол в градусах).
- **Сканирование:**
  - Задание параметров сканирования: радиус образца, шаг по радиусу, шаг по дуге, угол сканирования, задержка между точками.
  - Автоматическое перемещение по заданной траектории (концентрические окружности).
  - Захват температурных данных с камеры в каждой точке.
  - Отображение температурного распределения в реальном времени.
- **Вывод данных:**
  - Запись результатов сканирования в файлы форматов TXT, MD или CSV.
  - Построение графика температурного распределения.

## Структура проекта
project_root/
│
├── config.json # Основной конфигурационный файл JSON
├── config.cfg # Файл конфигурации шаговых двигателей
├── calibration_data.json # Данные калибровки камеры (создается/загружается)
├── pi640_config.xml # Конфигурационный файл для камеры Optris (из SDK)
├── requirements.txt # Зависимости Python
├── README.md # Этот файл
│
├── src/
│ ├── main.py # Точка входа в приложение
│ │
│ ├── config/
│ │ ├── config_manager.py # Управление загрузкой/сохранением конфига
│ │ └── config_model.py # Pydantic модель конфигурации
│ │
│ ├── hardware/
│ │ ├── stm32_controller.py # Взаимодействие с контроллером STM32
│ │ └── axis_controller.py # Логика управления осями X и Theta
│ │
│ ├── camera/
│ │ ├── optris_wrapper.py # ctypes обёртка для ImagerIPC2x64.dll
│ │ ├── camera_service.py # Высокоуровневая работа с камерой
│ │ ├── calibration_point.py # Класс точки калибровки
│ │ ├── calibration_data.py # Класс данных калибровки
│ │ └── calibration_service.py # Сервис калибровки камеры
│ │
│ ├── scan/
│ │ ├── scan_engine.py # Движок сканирования
│ │ ├── scan_planner.py # Расчёт траектории сканирования
│ │ ├── stepper_config.py # Конфигурация шаговых двигателей
│ │ └── data_writer.py # Запись результатов сканирования
│ │
│ ├── ui/
│ │ ├── main_window.py # Главное окно приложения
│ │ ├── calibration_window.py # Окно калибровки камеры
│ │ ├── debug_window.py # Окно отладки оборудования
│ │ └── config_editor.py # Окно редактора config.cfg
│ │
│ ├── utils/
│ │ ├── logger.py # Логирование
│ │ ├── math_utils.py # Математические функции
│ │ └── exceptions.py # Пользовательские исключения
│ │
│ └── plotting/
│ └── chart_controller.py # (Интеграция в UI)
│
└── tests/ # (Пока не реализовано)
└── ...


## Установка и запуск

1.  **Предварительные требования:**
    *   **Python 3.8 или выше.**
    *   **Библиотеки Optris:** Убедитесь, что `ImagerIPC2x64.dll` и `ImagerIPC2x64.lib` из Optris PI Connect SDK находятся в директории проекта или в системном `PATH`.
    *   **Драйверы:** Установите драйверы для вашей камеры Optris PI 640 и контроллера STM32 (если он создает виртуальный COM-порт).
    *   **Файл конфигурации камеры:** Убедитесь, что файл `pi640_config.xml` находится в директории проекта (или укажите путь к нему в `config.json`). Этот файл обычно поставляется с SDK.

2.  **Установка зависимостей:**
    *   Откройте терминал/командную строку в корневой директории проекта.
    *   Выполните команду:
        ```bash
        pip install -r requirements.txt
        ```

3.  **Запуск приложения:**
    *   В терминале выполните:
        ```bash
        python src/main.py
        ```
    *   **Аргументы командной строки:**
        - `--config PATH`: Указать путь к JSON-файлу конфигурации (по умолчанию `config.json`).
        - `--debug`: Включить подробное логирование.
        - `--no-xml-config`: Попытаться инициализировать камеру без `pi640_config.xml` (если поддерживается DLL).

## Конфигурация

- **`config.json`:** Основные настройки приложения (COM-порт, пути к файлам, параметры по умолчанию). Автоматически создается при первом запуске.
- **`config.cfg`:** Параметры шаговых двигателей (Spd, Acc, Cur и т.д.). Редактируется через меню "Инструменты" -> "Редактор конфигурации" или вручную. Формат совместим с оригинальной C# версией.

## Как правильно калибровать

1.  **Подготовка:**
    *   Убедитесь, что камера и контроллер подключены к компьютеру.
    *   Запустите приложение.

2.  **Механическая калибровка осей:**
    *   В главном окне нажмите кнопку "Контроллер" и выберите правильный COM-порт, затем нажмите "Подключить".
    *   После успешного подключения нажмите кнопку "Мех. калибровка".
    *   Подтвердите действие в диалоговом окне.
    *   Контроллер начнет перемещать оси в крайние положения по концевикам. Дождитесь завершения (сообщение в логе или статусной строке).

3.  **Калибровка камеры:**
    *   Убедитесь, что камера подключена (нажмите кнопку "Камера" -> "Подключить").
    *   Нажмите кнопку "Калибровка камеры". Откроется окно калибровки.
    *   Нажмите кнопку "Старт" для запуска режима "Live View".
    *   На изображении будет видно тепловое поле зеркала.
    *   **Добавление точек калибровки:**
        -   Выберите тип точки "Центр (0,0°)". Кликните левой кнопкой мыши в центр зеркала на изображении. Точка добавится.
        -   Выберите тип точки "Радиус (50мм, 0°)". Кликните в точку на краю зеркала, соответствующую радиусу 50мм и углу 0°.
        -   Выберите тип точки "Угол (50мм, 90°)". Кликните в точку на краю зеркала, соответствующую радию 50мм и углу 90°.
    *   После добавления всех 3 точек нажмите кнопку "Запустить калибровку".
    *   При успешной калибровке появится сообщение. Закройте окно калибровки.

4.  **Проверка калибровки:**
    *   Убедитесь, что в главном окне статус изменился на "Готов" и кнопка "Старт сканирования" стала активной.

## Использование

1.  **Настройка параметров сканирования:**
    *   В левой части главного окна задайте параметры:
        -   **Радиус:** Максимальный радиус сканирования (мм).
        -   **Шаг по радиусу:** Расстояние между концентрическими окружностями (мм).
        -   **Шаг по дуге:** Расстояние между точками на одной окружности (мм).
        -   **Угол:** Общий угол сканирования (градусы).
        -   **Задержка:** Время ожидания стабилизации температуры в каждой точке (мс).
        -   **Формат вывода:** TXT, MD или CSV.
        -   **Единицы угла:** Degrees или Dms (градусы-минуты-секунды).

2.  **Запуск сканирования:**
    *   Нажмите кнопку "Старт сканирования".
    *   Выберите путь и имя файла для сохранения результатов.
    *   Процесс сканирования начнется. Прогресс отображается в статусной строке.
    *   Температурное распределение будет отображаться на графике в реальном времени.

3.  **Остановка:**
    *   При необходимости сканирование можно остановить кнопкой "Стоп".

4.  **Просмотр результатов:**
    *   После завершения результаты будут сохранены в выбранном файле.
    *   График в приложении отобразит финальное распределение температур.

## Разработка

Проект структурирован по модульному принципу. Каждая папка в `src/` отвечает за определенную область функциональности. Для внесения изменений рекомендуется следовать существующей архитектуре.
